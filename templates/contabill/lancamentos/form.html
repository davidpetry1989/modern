{% extends "partials/base.html" %}
{% load static %}
{% block title %}Lançamento{% endblock title %}
{% block content %}
<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">

      {% block pagetitle %}{% include "partials/page-title.html" with pagetitle="Movimentação" title="Lançamento Contábil" %}{% endblock pagetitle %}

      {% if messages %}
        {% for message in messages %}
          <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <div class="card">
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            {% if form.errors %}
              <div class="alert alert-danger">Corrija os campos em destaque.</div>
            {% endif %}
            <div class="alert alert-danger" id="alert-desbalanceado" style="display:none;">Débitos e créditos não estão balanceados.</div>

            <!-- Cabeçalho do lançamento -->
            <div class="row g-3">
              {% if form.data_lancamento %}
              <div class="col-md-3">
                {{ form.data_lancamento.label_tag }}{{ form.data_lancamento }}
                {% for error in form.data_lancamento.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.data_competencia %}
              <div class="col-md-3">
                {{ form.data_competencia.label_tag }}{{ form.data_competencia }}
                {% for error in form.data_competencia.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.filial %}
              <div class="col-md-3">
                {{ form.filial.label_tag }}{{ form.filial }}
                {% for error in form.filial.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.numero_documento %}
              <div class="col-md-3">
                {{ form.numero_documento.label_tag }}{{ form.numero_documento }}
                {% for error in form.numero_documento.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.tipo_lancamento %}
              <div class="col-md-3">
                {{ form.tipo_lancamento.label_tag }}{{ form.tipo_lancamento }}
                {% for error in form.tipo_lancamento.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.origem %}
              <div class="col-md-3">
                {{ form.origem.label_tag }}{{ form.origem }}
                {% for error in form.origem.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.codigo_externo %}
              <div class="col-md-3">
                {{ form.codigo_externo.label_tag }}{{ form.codigo_externo }}
                {% for error in form.codigo_externo.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.status %}
              <div class="col-md-3">
                <div class="form-check mt-4">
                  {{ form.status }}
                  <label class="form-check-label" for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
                </div>
                {% for error in form.status.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.descricao %}
              <div class="col-12">
                {{ form.descricao.label_tag }}{{ form.descricao }}
                {% for error in form.descricao.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}
            </div>

            <hr class="my-4">

            <!-- Itens (formset) -->
            {% if itens_formset.non_form_errors %}
              <div class="alert alert-danger">{{ itens_formset.non_form_errors }}</div>
            {% endif %}

            {{ itens_formset.management_form }}
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="min-width:220px;">Conta Contábil</th>
                    <th style="min-width:180px;">Histórico</th>
                    <th style="min-width:120px;">Moeda</th>
                    <th style="min-width:110px;">Tipo (D/C)</th>
                    <th style="min-width:140px;">Valor</th>
                    <th style="min-width:160px;">Filial</th>
                    {% if itens_formset.empty_form.codigo_externo %}
                      <th style="min-width:160px;">Cód. Externo</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for f in itens_formset %}
                    {% if f.non_field_errors %}
                      <tr><td colspan="7"><div class="alert alert-danger my-2">{{ f.non_field_errors }}</div></td></tr>
                    {% endif %}
                    <tr>
                      <td>
                        {{ f.conta_contabil }}
                        {% for error in f.conta_contabil.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        {{ f.id }} {{ f.lancamento }}
                      </td>
                      <td>
                        {{ f.historico }}
                        {% for error in f.historico.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </td>
                      <td>
                        {{ f.moeda }}
                        {% for error in f.moeda.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </td>
                      <td style="max-width:120px;">
                        {{ f.tipo_dc }}
                        {% for error in f.tipo_dc.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </td>
                      <td style="max-width:160px;">
                        {{ f.valor }}
                        {% for error in f.valor.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </td>
                      <td>
                        {{ f.filial }}
                        {% for error in f.filial.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </td>
                      {% if f.codigo_externo %}
                      <td>
                        {{ f.codigo_externo }}
                        {% for error in f.codigo_externo.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                      </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">Total Débito:</th>
                    <th colspan="1"><span id="total-debito">R$ 0,00</span></th>
                    <th colspan="1" class="text-end">Total Crédito:</th>
                    <th colspan="1"><span id="total-credito">R$ 0,00</span></th>
                    <th colspan="1" class="text-end">Diferença:</th>
                    <th colspan="1"><span id="total-diferenca">R$ 0,00</span></th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="mt-3 d-flex justify-content-between">
              <div>
                <button type="submit" class="btn btn-success" id="btn-salvar">Salvar</button>
                <a href="{% url 'contabill:lancamentos_lista' %}" class="btn btn-secondary">Cancelar</a>
              </div>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>
</div>
<script>
(function(){
  function parseValor(v){
    if(!v) return 0;
    v = v.replace(/\./g,'').replace(',', '.');
    var n = Number(v);
    return isNaN(n) ? 0 : n;
  }
  function recalc(){
    var totalD = 0, totalC = 0;
    const linhas = document.querySelectorAll('input[name$="-valor"]').length;
    for (let i=0; i<linhas; i++){
      const del = document.querySelector('input[name="itens-' + i + '-DELETE"]');
      if (del && del.checked) continue;

      const tipo = document.querySelector('select[name="itens-' + i + '-tipo_dc"]');
      const val  = document.querySelector('input[name="itens-' + i + '-valor"]');
      if(!tipo || !val) continue;

      const num = parseValor(val.value);
      if (tipo.value === 'D') totalD += num;
      else if (tipo.value === 'C') totalC += num;
    }
    const dif = (totalD - totalC);
    const fmt = (n)=> n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    document.getElementById('total-debito').textContent   = fmt(totalD);
    document.getElementById('total-credito').textContent  = fmt(totalC);
    document.getElementById('total-diferenca').textContent= fmt(dif);

    const alerta = document.getElementById('alert-desbalanceado');
    const btnSalvar = document.getElementById('btn-salvar');
    if (Math.abs(dif) > 0.000001){
      if (alerta) alerta.style.display = '';
      if (btnSalvar) btnSalvar.disabled = true;
    } else {
      if (alerta) alerta.style.display = 'none';
      if (btnSalvar) btnSalvar.disabled = false;
    }
  }

  function bind(){
    const container = document;
    container.addEventListener('input', function(ev){
      const name = ev.target.name || '';
      if (name.endsWith('-valor')) recalc();
    });
    container.addEventListener('change', function(ev){
      const name = ev.target.name || '';
      if (name.endsWith('-tipo_dc') || name.endsWith('-DELETE')) recalc();
    });
    recalc();
  }
  document.addEventListener('DOMContentLoaded', bind);
})();
</script>
{% endblock content %}

